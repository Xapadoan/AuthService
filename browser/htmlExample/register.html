<!DOCTYPE html>
<html>
  <head>
    <title>Register</title>
  </head>
  <body>
    <form>
      <label for="email-input">Email: </label>
      <input id="email-input" type="email" />
      <button id="email-submit">OK</button>
      <br />
      <video id="video-input" width="640" height="360"></video>
      <button id="capture-button" disabled>Capture</button>
      <br />
      <canvas id="canvas" width="640" height="360"></canvas>
      <button id="send-button" disabled>Send</button>
    </form>
    <div id="picture-frame"></div>
    <script async defer type="module">
      import { initRegister, uploadRegister, finishRegister } from "../src";

      let initRegisterResult;
      let uploadRegisterResult;

      const width = 640;
      let height = 360;
      let streaming = false;
      const videoInput = document.getElementById('video-input');
      const canvas = document.getElementById('canvas');
      const captureButton = document.getElementById('capture-button');
      const sendButton = document.getElementById('send-button');

      async function sendPicture() {
        const data = canvas.toDataURL('image/png');
        console.log('Data: ', data);
        await uploadRegister(initRegisterResult.uploadUrl, {
          EACRegisterToken: initRegisterResult.EACRegisterToken,
          SVCRegisterToken: initRegisterResult.SVCRegisterToken,
          base64Image: data
        });
        await finishRegister('http://localhost:8081/auth/register/end', initRegisterResult.EACRegisterToken);
      }

      function takePicture() {
        const context = canvas.getContext('2d');
        context.drawImage(videoInput, 0, 0, width, height);

        sendButton.onclick = (e) => {
          e.preventDefault();
          sendPicture();
        }
        sendButton.disabled = false;
      }

      function onVideoStream(videoStream) {
        videoInput.srcObject = videoStream;
        videoInput.play();

        captureButton.onclick = (e) => {
          e.preventDefault();
          takePicture();
        }
        captureButton.disabled = false;
      }
      const emailSubmitButton = document.getElementById('email-submit');
      emailSubmitButton.onclick = (e) => {
        e.preventDefault();
        const emailInput = document.getElementById('email-input');
        initRegister('http://localhost:8081/auth/register/init', emailInput.value).then((res) => {
          console.log('Init Register Done: ', res);
          initRegisterResult = res;
        }).catch(console.error);
        navigator.mediaDevices.getUserMedia({
          video: {
            ideal: {
              with: 1280,
              height: 720,
            },
          },
        }).then(onVideoStream).catch(console.error);
        videoInput.addEventListener('canplay', () => {
          if (!streaming) {
            height = (videoInput.videoHeight / videoInput.videoWidth) * width;
            videoInput.setAttribute('width', width);
            videoInput.setAttribute('height', height);
            canvas.setAttribute('width', width);
            canvas.setAttribute('height', height);
            streaming = true;
          }
        })
      }
    </script>
  </body>
</html>