<!DOCTYPE html>
<html>
  <head>
    <title>Reset Upload</title>
  </head>
  <body>
    <form>
      <video id="video-input" width="640" height="360"></video>
      <button id="capture-button" disabled>Capture</button>
      <br />
      <canvas id="canvas" width="640" height="360"></canvas>
      <button id="send-button" disabled>Send</button>
    </form>
    <script async defer type="module">
      import { uploadReset, finishReset } from '../src'

      let initRegisterResult;
      let uploadRegisterResult;

      const width = 640;
      let height = 360;
      let streaming = false;
      const videoInput = document.getElementById('video-input');
      const canvas = document.getElementById('canvas');
      const captureButton = document.getElementById('capture-button');
      const sendButton = document.getElementById('send-button');
      const uploadUrl = localStorage.getItem('resetUploadUrl');
      const urlParams = new URLSearchParams(window.location.search);
      const SVCResetToken = urlParams.get('SVCResetToken');

      console.log('Token: ', SVCResetToken)

      async function sendPicture() {
        const data = canvas.toDataURL('image/png');
        console.log('Data: ', data);
        const { EACResetToken } = await uploadReset(uploadUrl, {
          SVCResetToken,
          base64Image: data
        });
        await finishReset('http://localhost:8081/auth/reset/end', EACResetToken);
      }

      function takePicture() {
        const context = canvas.getContext('2d');
        context.drawImage(videoInput, 0, 0, width, height);

        sendButton.onclick = (e) => {
          e.preventDefault();
          sendPicture();
        }
        sendButton.disabled = false;
      }

      function onVideoStream(videoStream) {
        videoInput.srcObject = videoStream;
        videoInput.play();

        captureButton.onclick = (e) => {
          e.preventDefault();
          takePicture();
        }
        captureButton.disabled = false;
      }

      navigator.mediaDevices.getUserMedia({
          video: {
            ideal: {
              with: 1280,
              height: 720,
            },
          },
        }).then(onVideoStream).catch(console.error);
        videoInput.addEventListener('canplay', () => {
          if (!streaming) {
            height = (videoInput.videoHeight / videoInput.videoWidth) * width;
            videoInput.setAttribute('width', width);
            videoInput.setAttribute('height', height);
            canvas.setAttribute('width', width);
            canvas.setAttribute('height', height);
            streaming = true;
          }
        })
    </script>
  </body>
</html>