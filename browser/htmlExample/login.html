<!DOCTYPE html>
<html>
  <head>
    <title>Login</title>
  </head>
  <body>
    <form>
      <label for="email-input">Email: </label>
      <input id="email-input" type="email" />
      <button id="email-submit">OK</button>
      <br />
      <video id="video-input" width="640" height="360"></video>
      <button id="capture-button" disabled>Capture</button>
      <br />
      <canvas id="canvas" width="640" height="360"></canvas>
      <button id="send-button" disabled>Send</button>
    </form>
    <script async defer type="module">
      import { initRestore, uploadRestore, finishRestore } from "../src";

      let initRestoreResult;
      let uploadRestoreResult;

      const width = 640;
      let height = 360;
      let streaming = false;
      const emailSubmitButton = document.getElementById('email-submit');
      const videoInput = document.getElementById('video-input');
      const canvas = document.getElementById('canvas');
      const captureButton = document.getElementById('capture-button');
      const sendButton = document.getElementById('send-button');

      async function sendPicture() {
        const data = canvas.toDataURL('image/png');
        console.log('Data: ', data);
        await uploadRestore(initRestoreResult.uploadUrl, {
          EACRestoreToken: initRestoreResult.EACRestoreToken,
          SVCRestoreToken: initRestoreResult.SVCRestoreToken,
          base64Image: data
        });
        await finishRestore('http://localhost:8081/auth/login/end', initRestoreResult.EACRestoreToken);
      }

      function takePicture() {
        const context = canvas.getContext('2d');
        context.drawImage(videoInput, 0, 0, width, height);

        sendButton.onclick = (e) => {
          e.preventDefault();
          sendPicture();
        }
        sendButton.disabled = false;
      }

      function onVideoStream(videoStream) {
        videoInput.srcObject = videoStream;
        videoInput.play();

        captureButton.onclick = (e) => {
          e.preventDefault();
          takePicture();
        }
        captureButton.disabled = false;
      }

      emailSubmitButton.onclick = (e) => {
        e.preventDefault();
        const emailInput = document.getElementById('email-input');
        initRestore('http://localhost:8081/auth/login/init', emailInput.value).then((res) => {
          console.log('Init Login Done: ', res);
          initRestoreResult = res;
        }).catch(console.error);
        navigator.mediaDevices.getUserMedia({
          video: {
            ideal: {
              with: 1280,
              height: 720,
            },
          },
        }).then(onVideoStream).catch(console.error);
        videoInput.addEventListener('canplay', () => {
          if (!streaming) {
            height = (videoInput.videoHeight / videoInput.videoWidth) * width;
            videoInput.setAttribute('width', width);
            videoInput.setAttribute('height', height);
            canvas.setAttribute('width', width);
            canvas.setAttribute('height', height);
            streaming = true;
          }
        })
      }
    </script>
  </body>
</html>